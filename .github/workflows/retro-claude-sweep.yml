name: Retro Claude Static Review (Flutter PRs)

on:
  workflow_dispatch: {}   # run manually for already-open PRs

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  DEFAULT_BRANCH: main
  MAX_PATCH_CHARS: "35000"

jobs:
  list-prs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Collect open PR numbers
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Use curl instead of gh api to avoid permission issues
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=100")

          echo "API Response: $response"

          # Check if response is valid JSON and contains data
          if echo "$response" | jq -e . >/dev/null 2>&1; then
            prs=$(echo "$response" | jq -r '.[] | select(.head.ref | test("^test-") | not) | .number' 2>/dev/null || echo "")
          else
            echo "Invalid JSON response from GitHub API"
            prs=""
          fi

          if [ -z "$prs" ]; then
            echo '{"include":[]}' > matrix.json
          else
            printf '{"include":[' > matrix.json
            first=1
            for p in $prs; do
              if [ $first -eq 0 ]; then printf ',' >> matrix.json; fi
              printf '{"pr":%s}' "$p" >> matrix.json
              first=0
            done
            printf ']}\n' >> matrix.json
          fi
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"
          echo "Found PRs: $prs"

  review:
    needs: list-prs
    if: ${{ fromJson(needs.list-prs.outputs.matrix).include != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    steps:
      - name: Prepare workspace
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Setup for PR review
        env:
          PR: ${{ matrix.pr }}
        run: |
          echo "Preparing to review PR #${PR}"

      - name: Checkout repo (so the action runs in the repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude static code review for this PR
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: >-
            --allowed-tools
            "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr edit:*),Bash(gh pr list:*),Bash(git fetch:*),Bash(git checkout:*),Bash(git log:*),Bash(git show:*)"
          prompt: |
            Please review PR #${{ matrix.pr }} in this Flutter repository.
            
            This is a Flutter Real-Time Messaging App Challenge submission. Please:
            
            1. Examine the PR changes and code structure
            2. Score each criterion 0-5 and compute weighted total out of 100:
               - Real-time messaging plumbing (20 points)
               - Message model completeness (10 points) 
               - Chat UI behaviors (15 points)
               - Architecture & layering (15 points)
               - State management consistency (10 points)
               - Repository pattern (10 points)
               - Error/loading states (10 points)
               - Git hygiene (5 points)
               - Security hygiene (5 points)
            
            3. Post a comment on the PR with:
               - Score table
               - **Weighted total (0-100)**
               - Red flags (if any)
               - Recommendation: **Advance/Hold/Reject**
               - Top 3 actionable fixes
            
            Focus on code quality, architecture, and Flutter best practices. Do not ask for text/copy content.

      - name: Label by score (optional)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ matrix.pr }}
        run: |
          body=$(gh pr view "$PR" --json comments -q '.comments[-1].body' || echo "")
          score=$(echo "$body" | grep -Eo '([0-9]{2,3})\s*/\s*100' | head -1 | sed -E 's#/.*##' || echo "")
          if [ -n "$score" ]; then
            if [ "$score" -ge 85 ]; then gh pr edit "$PR" --add-label "candidate:strong" || true; fi
            if [ "$score" -ge 70 ] && [ "$score" -lt 85 ]; then gh pr edit "$PR" --add-label "candidate:hold" || true; fi
            if [ "$score" -lt 70 ]; then gh pr edit "$PR" --add-label "candidate:reject" || true; fi
          fi
