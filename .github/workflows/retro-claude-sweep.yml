name: Retro Claude Static Review (Flutter PRs)

on:
  workflow_dispatch: {}   # run manually for already-open PRs

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  DEFAULT_BRANCH: main
  MAX_PATCH_CHARS: "35000"

jobs:
  list-prs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Collect open PR numbers
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # For testing, just process PR #1
          echo '{"include":[{"pr":1}]}' > matrix.json
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"
          echo "Testing with PR #1 only"

  review:
    needs: list-prs
    if: ${{ fromJson(needs.list-prs.outputs.matrix).include != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    steps:
      - name: Prepare workspace
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Setup for PR review
        env:
          PR: ${{ matrix.pr }}
        run: |
          echo "Preparing to review PR #${PR}"

      - name: Checkout repo (so the action runs in the repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude static code review for this PR
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: >-
            --allowed-tools
            "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr edit:*),Bash(gh pr list:*),Bash(git fetch:*),Bash(git checkout:*),Bash(git log:*),Bash(git show:*)"
          prompt: |
            Evaluate PR #${{ matrix.pr }}. Get PR title first, then post only:

            **PR: [Title] - Score: X/100**
            - Real-time messaging: X/20
            - Architecture/Structure: X/15
            - State management: X/15
            - UI/UX design: X/15
            - Code quality: X/15
            - Error handling: X/10
            - Performance: X/10

            **Notes:**
            - [brief observation]
            - [brief observation]
            - [brief observation]

      - name: Label by score
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ matrix.pr }}
        run: |
          body=$(gh pr view "$PR" --json comments -q '.comments[-1].body' || echo "")
          score=$(echo "$body" | grep -Eo '([0-9]{1,3})\s*/\s*100' | head -1 | sed -E 's#/.*##' || echo "")
          if [ -n "$score" ]; then
            if [ "$score" -ge 85 ]; then
              gh pr edit "$PR" --add-label "evaluation:excellent" || true
            elif [ "$score" -ge 70 ]; then
              gh pr edit "$PR" --add-label "evaluation:good" || true
            elif [ "$score" -ge 50 ]; then
              gh pr edit "$PR" --add-label "evaluation:average" || true
            else
              gh pr edit "$PR" --add-label "evaluation:needs-work" || true
            fi
          fi
