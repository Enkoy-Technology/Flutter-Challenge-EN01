name: Retro Claude Static Review (Flutter PRs)

on:
  workflow_dispatch: {}   # run manually for already-open PRs

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  DEFAULT_BRANCH: main
  MAX_PATCH_CHARS: "35000"

jobs:
  list-prs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Collect open PR numbers
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # For testing, just process PR #1
          echo '{"include":[{"pr":1}]}' > matrix.json
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"
          echo "Testing with PR #1 only"

  review:
    needs: list-prs
    if: ${{ fromJson(needs.list-prs.outputs.matrix).include != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    steps:
      - name: Prepare workspace
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Setup for PR review
        env:
          PR: ${{ matrix.pr }}
        run: |
          echo "Preparing to review PR #${PR}"

      - name: Checkout repo (so the action runs in the repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude static code review for this PR
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: >-
            --allowed-tools
            "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr edit:*),Bash(gh pr list:*),Bash(git fetch:*),Bash(git checkout:*),Bash(git log:*),Bash(git show:*)"
          prompt: |
            Evaluate PR #${{ matrix.pr }} as a SENIOR-LEVEL Flutter developer assessment. Get PR title first, then post:

            **PR: [Title] - Score: X/100**

            **Core Requirements:**
            - Real-Time & Streams: X/25 (Firestore/WebSocket streams, instant delivery, typing indicators)
            - Arch. & Code Readability: X/20 (Clean/layered architecture, repository pattern, readable code)
            - Separation of Concerns & State Management: X/20 (Riverpod/Bloc consistency, UI/business logic separation)
            - Error Handling & Loading States: X/15 (Network errors, empty states, loading indicators)
            - Features & UX: X/10 (Chat bubbles, auto-scroll, input field, responsive design)
            - Git & Commit Quality: X/10 (Clear commits, proper branch naming, PR description)

            **Bonus Features Found:** [List any: user identity, chat list, message status, notifications, unit tests]

            **Strengths:**
            1. [Specific technical strength with brief explanation]
            2. [Specific technical strength with brief explanation]
            3. [Specific technical strength with brief explanation]

            **Areas for improvement:**
            1. [Specific code issue found with brief explanation of why it needs improvement]
            2. [Specific code issue found with brief explanation of why it needs improvement]
            3. [Specific code issue found with brief explanation of why it needs improvement]

            Be detailed and specific. Only comment on what exists in their code. Don't suggest adding new features, only improving existing implementation quality.

      - name: Label by score
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ matrix.pr }}
        run: |
          body=$(gh pr view "$PR" --json comments -q '.comments[-1].body' || echo "")
          score=$(echo "$body" | grep -Eo '([0-9]{1,3})\s*/\s*100' | head -1 | sed -E 's#/.*##' || echo "")
          if [ -n "$score" ]; then
            if [ "$score" -ge 85 ]; then
              gh pr edit "$PR" --add-label "evaluation:excellent" || true
            elif [ "$score" -ge 70 ]; then
              gh pr edit "$PR" --add-label "evaluation:good" || true
            elif [ "$score" -ge 50 ]; then
              gh pr edit "$PR" --add-label "evaluation:average" || true
            else
              gh pr edit "$PR" --add-label "evaluation:needs-work" || true
            fi
          fi
